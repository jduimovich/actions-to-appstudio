# script to execute the pipeline locally to scrape the latest workflow run
# you don't need to run a new GH action to test this.
# also scripts the App Studio log to show what was pulled from Github.

SCRIPTDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
 
ID=$(gh run list  | head -1 | cut  -f 7) 

oc create secret generic token-secret --from-literal=token.txt=$MY_GITHUB_TOKEN > /dev/null 2>&1 || true   
BUILD_TAG=$(date +"%Y-%m-%d-%H%M%S")
REPO=$(basename `pwd`)
NAME=actions-to-appstudio-$BUILD_TAG
yq $SCRIPTDIR/pipelinerun.yaml | 
    yq e '.metadata.name = "'$NAME'"' |
    yq e '.spec.params[0].value = "'$MY_GITHUB_USER'"' | 
    yq e '.spec.params[1].value = "'$REPO'"' | 
    yq e '.spec.params[2].value = "'$ID'"' |   
    oc apply -f -  
 
# tkn fails because it doesn't support bundles 
#echo  tkn pr logs $NAME -f
#tkn pr logs $NAME -f 

# Look for pod (name hardcoded, if that changes, update here) 
PNAME=$NAME-gh-logs-watcher-pod 
echo "Waiting for $PNAME to spin up."
while [[ $(kubectl get pods $PNAME -o 'jsonpath={..status.conditions[?(@.type=="Ready")].status}') != "True" ]]
do 
    echo -n . 
    sleep 1
done 
echo
echo "Logs:"
oc logs $PNAME -f 